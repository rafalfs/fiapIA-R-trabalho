---
title: "Enriquecimento Dataset"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Enriquecimento do dataset com dados meteorológicos

### Importação das bibliotecas

```{r}
import = function(libName){
  result = tryCatch({
    library(libName, character.only = T)
  }, error = function(e) {
    install.packages(libName, repos = "http://cran.us.r-project.org")
    library(libName, character.only = T)
  })
}

import("readr")
import("ggmap")
import("ggplot2")
import("mapview")
import("sf")
import("dplyr")
import("shiny")
import("lubridate")
import("weathermetrics")
import("magrittr")
```

### Carga dos datasets

Primeiramente fizemos a carga do dataset de treino

```{r}
train_db = read_csv("data/train/train.csv",locale = locale(encoding = "ISO-8859-1"))
df_train = data.frame(train_db)
```

E em seguida do dataset de dados meteorológicos utilizados para enriquecimento da nossa base
O Dataset está disponível em: https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=3&cad=rja&uact=8&ved=0ahUKEwiOkfaq9KbbAhWHH5AKHfxLA_gQFgg0MAI&url=https%3A%2F%2Fkaggle2.blob.core.windows.net%2Fforum-message-attachments%2F205166%2F6860%2Fweather_data_nyc_centralpark_2016.csv&usg=AOvVaw3q_fypt-TvzObsOwukL8FU

```{r}
weather_db = read_csv("data/datasets/weather_nyc_2016.csv",locale = locale(encoding = "ISO-8859-1"))
df_weather = data.frame(weather_db)
```

### Preparação dos dados de enriquecimento

Fizemos o tratamento dos dados climáticos para converter a data para um objeto do lubridate, conversão da temperatura de fahrenheit para celcius, substituir o "T" que indica um baixo índice para um valor pequeno e fizemos uma flag indicando se choveu ou se nevou

```{r}
df_weather %>%
  mutate(date = dmy(date),
         rain = as.numeric(ifelse(precipitation == "T", "0.01", precipitation)),
         snow_fall = as.numeric(ifelse(snow.fall == "T", "0.01", snow.fall)),
         snow_depth = as.numeric(ifelse(snow.depth == "T", "0.01", snow.depth)),
         all_precip = snow_fall + rain,
         has_snow = (snow_fall > 0) | (snow_depth > 0),
         has_rain = rain > 0,
         max_temp = fahrenheit.to.celsius(maximum.temerature),
         min_temp = fahrenheit.to.celsius(minimum.temperature),
         avg_temp = fahrenheit.to.celsius(average.temperature)) -> df_weather
```

Conversão da data do dataset de treino para lubridate para posteriormente fazer o join com o dataset de dados meteorológicos pela data

```{r}
df_train %>% 
  mutate(date = as.Date(ymd_hms(pickup_datetime))) -> df_train
```


Seleção apenas das colunas que queremos acrescentar ao dataset de treino

```{r}
weather <- df_weather %>%
  select(date, rain, snow_fall, all_precip, has_snow, has_rain, snow_depth, max_temp, min_temp)
```

Join do dataset meteorológico com o dataset de treino pela data

```{r}
df_train = left_join(df_train, weather, by = "date")
```

# Enriquecimento do dataset com feriados

Fizemos também o enriquecimento da base com dados de feriados em New York
Montamos um csv com os dados da seguinte fonte: https://www.officeholidays.com/countries/usa/regional.php?list_year=2016&list_region=New%20York

Carregamos o csv para a memória, renomeamos alguns campos e convertemos a data para o formato do lubridate

```{r}
holidays_db = read_csv("data/datasets/holidays.csv",locale = locale(encoding = "ISO-8859-1"))
df_holidays = data.frame(holidays_db)

colnames(df_holidays)[1] = "holiday_weekday"
colnames(df_holidays)[3] = "holiday"

df_holidays %>% 
  mutate(date = ymd(date)) -> df_holidays
```

Fazemos o join da nossa base de treinamento com nossa base de feriados

```{r}
df_train = left_join(df_train, df_holidays, by = "date")
```